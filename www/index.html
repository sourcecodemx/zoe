<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width">
  <title>Zoe Water</title>

  <link rel="stylesheet" href="/stylesheets/app.css" />
  <link rel="stylesheet" href="/components/animate.css/animate.min.css" />

  <script src="/javascripts/onerror.js"></script>
  <script src="/javascripts/console.log.js"></script>

  <!-- cordova.js is served from localhost to ensure the correct version -->
  <script src="http://localhost/cordova.js"></script>
  <script src="http://localhost/javascripts/zoe.js"></script>
  <script src="/components/steroids-js/steroids.js"></script>
  <script>
    //Pollute the global namespace with the setupEvent (thanks to Phonegap architecture)
    window.setupEvent = new Event('setup');

    var onSetup = function(){
      require(['AuthController', 'HomeController'], function(Auth, Home){
        //Initialize function, will be used for refreshing
        //the view later
        var initialize = function(){
          if(Parse.User.current()){
            return new Home.Index().show();
          }else{
            return new Auth.Index().show();
          }
        };
        var view = initialize();
        //Listen for messages
        var onMessage = function(event){
          var data = event.data;
          //Did we authenticate?
          this.authed = data.message === 'login' || data.message === 'signup';
          this.message = data.message;

          if(this.authed && data.token){
            window.showLoading('Sincronizando...');
            //Login with passed token
            Parse.User.become(data.token, {
              success: function(){
                //Destroy current view
                this.view.destroy();
                this.view = null;
                //Create home view
                this.view = this.fn();
                //Hide loading
                window.hideLoading();
              }.bind(this),
              error: function(){
                window.hideLoading();

                setTimeout(function(){
                  navigator.notification.alert('Error al iniciar sesion', $.noop, 'Error');
                }, 1);
              }
            });
          }else if(data.message === 'logout'){
            //Logout
            Parse.User.logOut();
            //Clear view instance
            this.view.destroy();
            this.view = null;
            //Create new view
            this.view = this.fn();
          }
        }.bind({view: view, fn: initialize});

        //Listen for auth/deauth messages, this is needed
        //because of the way Steroids is architected
        window.addEventListener('message', onMessage);
      });
    }

    // Listen for the event.
    window.addEventListener('setup', onSetup, false);
  </script>
</head>
<body>
  <script src="/components/requirejs/require.js" data-main="http://localhost/javascripts/application"></script>
  <!--script src="http://192.168.1.130:31173/target/target-script-min.js#anonymous"></script-->
</body>
</html>
