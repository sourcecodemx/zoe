<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width">
  <title>Zoe Water</title>

  <link rel="stylesheet" href="/stylesheets/app.css" />
  <link rel="stylesheet" href="/components/animate.css/animate.min.css" />

  <script src="/javascripts/onerror.js"></script>
  <script src="/javascripts/console.log.js"></script>

  <!-- cordova.js is served from localhost to ensure the correct version -->
  <script src="http://localhost/cordova.js"></script>
  <script src="http://localhost/MapKit.js"></script>

  <script src="http://localhost/javascripts/zoe.js"></script>
  <script src="/components/steroids-js/steroids.js"></script>
  <script>
    //Pollute the global namespace with the setupEvent (thanks to Phonegap architecture)
    window.setupEvent = new Event('setup');

    var onSetup = function(){
      //Cleanup previously loaded views
      var items = _.keys(localStorage);
      var preloaded = _.filter(items, function(i){return i.indexOf('-preloaded') > -1;});

      if(preloaded && preloaded.length){
        _.each(preloaded, function(i){
          localStorage.removeItem(i);
        });
      }

      require(['Auth', 'Home', 'APIController'], function(Auth, Home, API){
        //CManages API calls
        window.ZOEApiManager = API;
        //Initialize function, will be used for refreshing
        //the view later
        var initialize = function(){
          if(Parse.User.current()){
            return new Home({model: Parse.User.current()}).show();
          }else{
            //Login index
            return new Auth().show();
          }
        };
        var view = window.view = initialize();
        //Listen for messages
        var onMessage = function(event){
          var data = event.data;
          var reload = function(){
            //Destroy current view
            this.view.destroy();
            this.view = null;
            //Create home view
            this.view = window.view = this.fn();
            //Hide loading
            window.hideLoading();
          }.bind(this);
          
          switch(data.message){
          case 'fbauth':
          case 'reload':
          case 'user:saved:login':
          case 'user:saved:signup':
            reload();
            break;
          case 'logout':
            //Logout
            Parse.User.logOut();
            reload();
            break;
          }
        }.bind({view: view, fn: initialize});

        //Listen for auth/deauth messages, this is needed
        //because of the way Steroids is architected
        window.addEventListener('message', onMessage);
      });
    }

    // Listen for the event.
    window.addEventListener('setup', onSetup, false);
  </script>
</head>
<body>
  <script src="/components/requirejs/require.js" data-main="http://localhost/javascripts/application"></script>
</body>
</html>
