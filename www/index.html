<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width">
  <title>Zoe Water</title>

  <link rel="stylesheet" href="/stylesheets/app.css" />
  <link rel="stylesheet" href="/components/animate.css/animate.min.css" />

  <script src="/javascripts/onerror.js"></script>
  <script src="/javascripts/console.log.js"></script>

  <!-- cordova.js is served from localhost to ensure the correct version -->
  <script src="http://localhost/cordova.js"></script>
  <script src="http://localhost/SocialSharing.js"></script>

  <script src="http://localhost/javascripts/zoe.js"></script>
  <script src="/components/steroids-js/steroids.js"></script>
  <script>
    //Pollute the global namespace with the setupEvent (thanks to Phonegap architecture)
    window.setupEvent = new Event('setup');

    var onSetup = function(){
      //Cleanup previously loaded views
      var items = _.keys(localStorage);
      var preloaded = _.filter(items, function(i){return i.indexOf('-preloaded') > -1;});

      if(preloaded && preloaded.length){
        _.each(preloaded, function(i){
          localStorage.removeItem(i);
        });
      }

      require(['Auth', 'Home', 'APIController'], function(Auth, Home, API){
        //CManages API calls
        window.ZOEApiManager = API;
        //Listen for messages
        var destroy = function(){
          if(window.view && window.view.destroy){
            window.view.destroy();
            window.view = null;
          }
        }
        var onMessage = function(event){
          var data = event.data;
          switch(data.message){
          case 'user:login:success':
          case 'user:signup:success':
            destroy();
            window.view = new Home();
            window.view.show();
            window.hideLoading();
            break;
          case 'user:logout:success':
            destroy();
            window.view = new Auth();
            window.view.show();
            window.hideLoading();
            break;
          }
        };

        //Listen for auth/deauth messages, this is needed
        //because of the way Steroids is architected
        window.addEventListener('message', onMessage);

        //Initialize main view
        window.view = Parse.User.current() ?
          (new Home({model: Parse.User.current()})).show() :
          (new Auth()).show();
      });
    }

    // Listen for the event.
    window.addEventListener('setup', onSetup, false);
  </script>
</head>
<body>
  <script src="/components/requirejs/require.js" data-main="http://localhost/javascripts/application"></script>
</body>
</html>
