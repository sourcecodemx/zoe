<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width">
    <title>Root Views Manager</title>

    <link rel="stylesheet" href="/stylesheets/app.css" />

    <script src="/javascripts/onerror.js"></script>
    <script src="/javascripts/console.log.js"></script>

    <!-- cordova.js is served from localhost to ensure the correct version -->
    <script src="http://localhost/cordova.js"></script>
    <script src="/components/steroids-js/steroids.js"></script>
    <script>
        /**
        * This document is intented to be used to manage root views
        * We will handle root views creation and destruction as well
        * as their insertion into the app layer
        *
        * Let's say that we want to move from the home page to the blog page,
        * (blog page as a few others have the particularity to be root pages
        * it means that those are the top most views at any given point) while
        * we're somewhere else inthe application, we could only do the following
        * 
        * window.postMessage({messae: 'page:open', id: 'blog'})
        *
        * The previous line of code will unchain a series of events better described
        * by the code below, I have tried to keep it as simple as possible, I beg your
        * pardon if I did otherwise.
        *
        * Still we have other pages that may look like a root view:
        * - Settings
        * - Authentication flow
        * I have left those two out of this script because of the follwoing:
        *
        * Settings:
        * It is only svailable through the home view
        *
        * Auth:
        * It is the entry point of the application and as such it should be treated
        * differently as the other views, killed or restored as needed 
        */
        //Add capitalize function to String's prototype
        String.prototype.capitalize = function () {
            return this.replace(/^./, function (char) {
                return char.toUpperCase();
            });
        };
        //Global views object
        window.views = {};

        //onMessage function
        function onMessage(event){
            var d = event.data;
            var view, id;

            if(d.message){
                //Grab page id if it exists
                id = d.id || null;

                switch(d.message){
                case 'page:open':
                    if(id){

                        switch(id){
                        case 'blog':
                        case 'gallery':
                        case 'pos':
                        case 'premier':
                        case 'store':
                            if(!views[id]){
                                views[id] = new steroids.views.WebView({location: 'http://localhost/views/' + id.capitalize() + '/index.html', id: id + 'View'});
                            }

                            view = views[id];
                            break;
                        }

                        if(view instanceof steroids.views.WebView){
                            view.preload({}, {
                                onSuccess: function(){
                                    setTimeout(function(){
                                        steroids.layers.replace(window.views[id]);
                                    },1);
                                },
                                onFailure: function(){
                                    setTimeout(function(){
                                        navigator.notification.alert(
                                            'Ha ocurrido un error al cargar la vista, por favor intente de nuevo', 
                                            function(){}, 
                                            'Ups!'
                                        );
                                    },1);
                                    console.log(arguments, 'load failure');
                                }
                            });
                        }
                    }
                    break;

                case 'page:unload':
                    if(id && window.views[id]){
                        window.views[id].unload();
                    }
                    break;
                }
            }
        };
        //Add listener
        window.addEventListener('message', onMessage.bind(this));
    </script>
</head>
<body>
</body>
</html>
